---

on:
    check_suite:  # ALWAYS triggered from the default branch
        # Ref: https://help.github.com/en/actions/reference/events-that-trigger-workflows#check-suite-event-check_suite
        types:
            - completed

jobs:
    # Use the latest published version of the cirrus-ci_retrospective action to
    # determine the execution context of _this_ workflow run.
    cirrus-ci_retrospective:
        # Do not execute for other github applications, only works with cirrus-ci
        if: github.event.check_suite.app.name == 'Cirrus CI'
        runs-on: ubuntu-latest
        steps:
            - id: cirrus-ci_retrospective
              uses: docker://quay.io/libpod/cirrus-ci_retrospective:latest
              env:
                GITHUB_TOKEN: ${{ github.token }}

            - id: success_pr
              shell: bash
              run: >-
                  printf \
                  "::set-output name=value::%s" \
                  $(jq '.[] | select(.name == "cirrus-ci/test_success") | .build.pullRequest' \
                    ./cirrus-ci_retrospective.json)

            - run: echo "${{ steps.success_pr.outputs.value }}"

            - if: "!contains(steps.success_pr.outputs.value, 'null')"
              # Needed to clone the code from PR HEAD
              id: success_sha
              shell: bash
              run: >-
                  printf \
                  "::set-output name=value::%s" \
                  $(jq '.[] | select(.name == "cirrus-ci/test_success") | .build.changeIdInRepo' \
                    ./cirrus-ci_retrospective.json)

            - run: echo "${{ steps.success_sha.outputs.value }}"

            - if: "!contains(steps.success_pr.outputs.value, 'null') && !contains(steps.success_sha.outputs.value, 'null')"
              uses: actions/checkout@v2
              with:
                  ref: ${{ steps.success_sha.value }}
                  path: ./

            # Execute the PR's version of the cirrus-ci_retrospective script in debugging mode
            - if: "!contains(steps.success_pr.outputs.value, 'null') && !contains(steps.success_sha.outputs.value, 'null')"
              run: $GITHUB_WORKSPACE/cirrus-ci_retrospective/bin/debug.sh &> $GITHUB_WORKSPACE/debug.output
              env:
                GITHUB_EVENT_PATH: ${{ github.event_path }}
                GITHUB_WORKSPACE: ${{ github.workspace }}
                GITHUB_TOKEN: ${{ github.token }}
                DEBUG: 'true'

            - if: "!contains(steps.success_pr.outputs.value, 'null') && !contains(steps.success_sha.outputs.value, 'null')"
              uses: actions/upload-artifact@v1.0.0
              with:
                  name: cirrus-ci_retrospective.json.zip
                  path: ./cirrus-ci_retrospective.json

            # FIXME: Just a stub
            # Provide the output and a link as feedback to the PR author
            - if: "!contains(steps.success_pr.outputs.value, 'null') && !contains(steps.success_sha.outputs.value, 'null')"
              shell: bash
              run: cat ./debug.output

    debug:
        # Avoid useless executions
        if: github.event.check_suite.app.name == 'Cirrus CI'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/upload-artifact@v1.0.0
              with:
                  # There is no way to avoid this being zipped :(
                  name: event.json.zip
                  path: ${{ github.event_path }}
